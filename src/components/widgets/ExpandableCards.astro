---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import Image from '~/components/common/Image.astro';

interface Card {
  title: string;
  image: {
    src: string;
    alt: string;
  };
  summary: string;
  content: string;
}

interface Props {
  title?: string;
  subtitle?: string;
  tagline?: string;
  cards?: Card[];
  id?: string;
  isDark?: boolean;
  classes?: Record<string, string>;
  bg?: string;
}

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),
  cards = [],
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-6xl ${classes?.container ?? ''}`} bg={bg}>
  <Headline
    title={title}
    subtitle={subtitle}
    tagline={tagline}
    classes={(classes?.headline || {}) as Record<string, string>}
  />

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
    {
      cards.map((card, index) => (
        <div class="expandable-card rounded-lg shadow-lg overflow-hidden transition-all duration-300">
          <div class="relative card-container">
            <Image
              src={card.image.src}
              alt={card.image.alt}
              class="w-full h-full object-cover card-image absolute inset-0"
              widths={[400, 768]}
              sizes="(max-width: 768px) 100vw, 400px"
              loading="lazy"
            />

            {/* Overlay gradient for better text readability */}
            <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-black/50 to-black/70" />

            <div class="relative p-6 flex flex-col justify-end text-white card-content">
              <h3 class="text-xl font-bold mb-3 drop-shadow-lg">{card.title}</h3>

              <p class="mb-4 drop-shadow-md">{card.summary}</p>

              <div class="expandable-content max-h-0 transition-all duration-500 ease-in-out">
                <div class="pt-4 border-t border-white/30 expandable-inner">
                  <div class="prose prose-sm prose-invert max-w-none" set:html={card.content} />
                </div>
              </div>

              <button
                class="expand-btn mt-4 flex items-center gap-2 text-white hover:text-gray-200 transition-colors duration-200 font-semibold self-start"
                aria-expanded="false"
                aria-controls={`card-content-${index}`}
              >
                <span class="expand-text">Citiți mai mult</span>
                <svg
                  class="expand-icon w-5 h-5 transition-transform duration-300"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      ))
    }
  </div>
</WidgetWrapper>

<script>
  function initializeExpandableCards() {
    const cards = document.querySelectorAll('.expandable-card');

    cards.forEach((card) => {
      const button = card.querySelector('.expand-btn');
      const content = card.querySelector('.expandable-content');
      const icon = card.querySelector('.expand-icon');
      const text = card.querySelector('.expand-text');

      if (!button || !content || !icon || !text) return;

      // Remove existing listener if any (to prevent duplicates)
      const newButton = button.cloneNode(true) as HTMLElement;
      button.parentNode?.replaceChild(newButton, button);

      newButton.addEventListener('click', () => {
        const isExpanded = newButton.getAttribute('aria-expanded') === 'true';

        if (isExpanded) {
          // Collapse
          (content as HTMLElement).style.maxHeight = '0';
          newButton.setAttribute('aria-expanded', 'false');
          (icon as HTMLElement).style.transform = 'rotate(0deg)';
          (text as HTMLElement).textContent = 'Citiți mai mult';
          card.classList.remove('expanded');
        } else {
          // Expand - set to a fixed height to allow scrolling
          (content as HTMLElement).style.maxHeight = '200px';
          newButton.setAttribute('aria-expanded', 'true');
          (icon as HTMLElement).style.transform = 'rotate(180deg)';
          (text as HTMLElement).textContent = 'Citiți mai puțin';
          card.classList.add('expanded');
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initializeExpandableCards);

  // Re-initialize after Astro view transitions (if enabled)
  document.addEventListener('astro:page-load', initializeExpandableCards);

  // Fallback: also initialize immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    // DOM still loading, wait for DOMContentLoaded
  } else {
    // DOM already loaded
    initializeExpandableCards();
  }
</script>

<style>
  .expandable-card {
    position: relative;
  }

  .expandable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  }

  .card-container {
    height: 350px;
    transition: height 0.5s ease-in-out;
  }

  .expandable-card.expanded .card-container {
    height: 500px;
  }

  .card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-content {
    min-height: 350px;
  }

  .expandable-card.expanded .card-content {
    min-height: 500px;
  }

  .expandable-content {
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.5) transparent;
  }

  .expandable-content::-webkit-scrollbar {
    width: 6px;
  }

  .expandable-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .expandable-content::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 3px;
  }

  .expandable-content::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.7);
  }

  .prose :global(h4) {
    font-size: 1.125rem;
    font-weight: 700;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: white;
  }

  .prose :global(p) {
    margin-bottom: 0.75rem;
    color: white;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    color: white;
  }

  .prose :global(li) {
    margin-bottom: 0.25rem;
    color: white;
  }
</style>
